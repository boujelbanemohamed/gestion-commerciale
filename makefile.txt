.PHONY: help build up down restart logs clean db-connect install git-status git-push git-deploy

# Couleurs pour l'affichage
BLUE := \033[0;34m
GREEN := \033[0;32m
YELLOW := \033[0;33m
NC := \033[0m # No Color

help: ## Affiche cette aide
	@echo "$(BLUE)‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó$(NC)"
	@echo "$(BLUE)‚ïë  Gestion Commerciale - Commandes Make   ‚ïë$(NC)"
	@echo "$(BLUE)‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù$(NC)"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "$(GREEN)%-20s$(NC) %s\n", $$1, $$2}'
	@echo ""

install: ## Installation initiale (cr√©ation des dossiers)
	@echo "$(YELLOW)üì¶ Installation de la structure...$(NC)"
	@mkdir -p backend frontend/src frontend/public
	@echo "$(GREEN)‚úÖ Structure cr√©√©e$(NC)"

build: ## Construire tous les services
	@echo "$(YELLOW)üî® Construction des services...$(NC)"
	@docker-compose build
	@echo "$(GREEN)‚úÖ Construction termin√©e$(NC)"

up: ## D√©marrer l'application
	@echo "$(YELLOW)üöÄ D√©marrage de l'application...$(NC)"
	@docker-compose up -d
	@echo "$(GREEN)‚úÖ Application d√©marr√©e$(NC)"
	@echo ""
	@echo "$(BLUE)üì± Frontend:$(NC) http://localhost:3000"
	@echo "$(BLUE)üîå API:$(NC)      http://localhost:5000/api"
	@echo ""

dev: ## D√©marrer en mode d√©veloppement (avec logs)
	@echo "$(YELLOW)üîß D√©marrage en mode d√©veloppement...$(NC)"
	@docker-compose up

stop: ## Arr√™ter l'application
	@echo "$(YELLOW)‚è∏Ô∏è  Arr√™t de l'application...$(NC)"
	@docker-compose stop
	@echo "$(GREEN)‚úÖ Application arr√™t√©e$(NC)"

down: ## Arr√™ter et supprimer les conteneurs
	@echo "$(YELLOW)üóëÔ∏è  Suppression des conteneurs...$(NC)"
	@docker-compose down
	@echo "$(GREEN)‚úÖ Conteneurs supprim√©s$(NC)"

restart: ## Red√©marrer l'application
	@echo "$(YELLOW)‚ôªÔ∏è  Red√©marrage...$(NC)"
	@make down
	@make up

rebuild: ## Reconstruire et red√©marrer
	@echo "$(YELLOW)üîÑ Reconstruction compl√®te...$(NC)"
	@make down
	@make build
	@make up

logs: ## Voir les logs en temps r√©el
	@docker-compose logs -f

logs-backend: ## Voir les logs du backend
	@docker-compose logs -f backend

logs-frontend: ## Voir les logs du frontend
	@docker-compose logs -f frontend

logs-db: ## Voir les logs de la base de donn√©es
	@docker-compose logs -f postgres

ps: ## Voir l'√©tat des services
	@docker-compose ps

db-connect: ## Se connecter √† PostgreSQL
	@echo "$(BLUE)üóÑÔ∏è  Connexion √† PostgreSQL...$(NC)"
	@docker exec -it gestion_db psql -U admin -d gestion_commerciale

db-reset: ## R√©initialiser la base de donn√©es
	@echo "$(YELLOW)‚ö†Ô∏è  R√©initialisation de la base de donn√©es...$(NC)"
	@docker-compose down -v
	@docker-compose up -d postgres
	@sleep 5
	@docker-compose up -d backend frontend
	@echo "$(GREEN)‚úÖ Base de donn√©es r√©initialis√©e$(NC)"

clean: ## Nettoyer compl√®tement (conteneurs + volumes + images)
	@echo "$(YELLOW)üßπ Nettoyage complet...$(NC)"
	@docker-compose down -v --rmi all
	@echo "$(GREEN)‚úÖ Nettoyage termin√©$(NC)"

shell-backend: ## Acc√©der au shell du backend
	@docker exec -it gestion_backend sh

shell-frontend: ## Acc√©der au shell du frontend
	@docker exec -it gestion_frontend sh

status: ## Afficher le statut complet
	@echo "$(BLUE)‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó$(NC)"
	@echo "$(BLUE)‚ïë         √âtat de l'Application            ‚ïë$(NC)"
	@echo "$(BLUE)‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù$(NC)"
	@echo ""
	@docker-compose ps
	@echo ""
	@echo "$(BLUE)üìä Statistiques Docker:$(NC)"
	@docker stats --no-stream gestion_frontend gestion_backend gestion_db 2>/dev/null || echo "Services non d√©marr√©s"

test-api: ## Tester l'API
	@echo "$(BLUE)üß™ Test de l'API...$(NC)"
	@curl -s http://localhost:5000/api | jq . || echo "API non disponible"

backup-db: ## Sauvegarder la base de donn√©es
	@echo "$(YELLOW)üíæ Sauvegarde de la base de donn√©es...$(NC)"
	@docker exec gestion_db pg_dump -U admin gestion_commerciale > backup_$(shell date +%Y%m%d_%H%M%S).sql
	@echo "$(GREEN)‚úÖ Sauvegarde cr√©√©e$(NC)"

default: help

# ==============================
# Git
# ==============================

git-status: ## Afficher l'√©tat git
	@git status

git-push: ## Push (utilise le credential helper / Keychain)
	@git push origin $$(git branch --show-current)

git-deploy: ## D√©ploiement Git s√©curis√© (supporte GITHUB_TOKEN via env)
	@./git_deploy.sh