.PHONY: help build up down restart logs clean db-connect install

# Couleurs pour l'affichage
BLUE := \033[0;34m
GREEN := \033[0;32m
YELLOW := \033[0;33m
NC := \033[0m # No Color

help: ## Affiche cette aide
	@echo "$(BLUE)â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—$(NC)"
	@echo "$(BLUE)â•‘  Gestion Commerciale - Commandes Make   â•‘$(NC)"
	@echo "$(BLUE)â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "$(GREEN)%-20s$(NC) %s\n", $$1, $$2}'
	@echo ""

install: ## Installation initiale (crÃ©ation des dossiers)
	@echo "$(YELLOW)ðŸ“¦ Installation de la structure...$(NC)"
	@mkdir -p backend frontend/src frontend/public
	@echo "$(GREEN)âœ… Structure crÃ©Ã©e$(NC)"

build: ## Construire tous les services
	@echo "$(YELLOW)ðŸ”¨ Construction des services...$(NC)"
	@docker-compose build
	@echo "$(GREEN)âœ… Construction terminÃ©e$(NC)"

up: ## DÃ©marrer l'application
	@echo "$(YELLOW)ðŸš€ DÃ©marrage de l'application...$(NC)"
	@docker-compose up -d
	@echo "$(GREEN)âœ… Application dÃ©marrÃ©e$(NC)"
	@echo ""
	@echo "$(BLUE)ðŸ“± Frontend:$(NC) http://localhost:3000"
	@echo "$(BLUE)ðŸ”Œ API:$(NC)      http://localhost:5000/api"
	@echo ""

dev: ## DÃ©marrer en mode dÃ©veloppement (avec logs)
	@echo "$(YELLOW)ðŸ”§ DÃ©marrage en mode dÃ©veloppement...$(NC)"
	@docker-compose up

stop: ## ArrÃªter l'application
	@echo "$(YELLOW)â¸ï¸  ArrÃªt de l'application...$(NC)"
	@docker-compose stop
	@echo "$(GREEN)âœ… Application arrÃªtÃ©e$(NC)"

down: ## ArrÃªter et supprimer les conteneurs
	@echo "$(YELLOW)ðŸ—‘ï¸  Suppression des conteneurs...$(NC)"
	@docker-compose down
	@echo "$(GREEN)âœ… Conteneurs supprimÃ©s$(NC)"

restart: ## RedÃ©marrer l'application
	@echo "$(YELLOW)â™»ï¸  RedÃ©marrage...$(NC)"
	@make down
	@make up

rebuild: ## Reconstruire et redÃ©marrer
	@echo "$(YELLOW)ðŸ”„ Reconstruction complÃ¨te...$(NC)"
	@make down
	@make build
	@make up

logs: ## Voir les logs en temps rÃ©el
	@docker-compose logs -f

logs-backend: ## Voir les logs du backend
	@docker-compose logs -f backend

logs-frontend: ## Voir les logs du frontend
	@docker-compose logs -f frontend

logs-db: ## Voir les logs de la base de donnÃ©es
	@docker-compose logs -f postgres

ps: ## Voir l'Ã©tat des services
	@docker-compose ps

db-connect: ## Se connecter Ã  PostgreSQL
	@echo "$(BLUE)ðŸ—„ï¸  Connexion Ã  PostgreSQL...$(NC)"
	@docker exec -it gestion_db psql -U admin -d gestion_commerciale

db-reset: ## RÃ©initialiser la base de donnÃ©es
	@echo "$(YELLOW)âš ï¸  RÃ©initialisation de la base de donnÃ©es...$(NC)"
	@docker-compose down -v
	@docker-compose up -d postgres
	@sleep 5
	@docker-compose up -d backend frontend
	@echo "$(GREEN)âœ… Base de donnÃ©es rÃ©initialisÃ©e$(NC)"

clean: ## Nettoyer complÃ¨tement (conteneurs + volumes + images)
	@echo "$(YELLOW)ðŸ§¹ Nettoyage complet...$(NC)"
	@docker-compose down -v --rmi all
	@echo "$(GREEN)âœ… Nettoyage terminÃ©$(NC)"

shell-backend: ## AccÃ©der au shell du backend
	@docker exec -it gestion_backend sh

shell-frontend: ## AccÃ©der au shell du frontend
	@docker exec -it gestion_frontend sh

status: ## Afficher le statut complet
	@echo "$(BLUE)â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—$(NC)"
	@echo "$(BLUE)â•‘         Ã‰tat de l'Application            â•‘$(NC)"
	@echo "$(BLUE)â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"
	@echo ""
	@docker-compose ps
	@echo ""
	@echo "$(BLUE)ðŸ“Š Statistiques Docker:$(NC)"
	@docker stats --no-stream gestion_frontend gestion_backend gestion_db 2>/dev/null || echo "Services non dÃ©marrÃ©s"

test-api: ## Tester l'API
	@echo "$(BLUE)ðŸ§ª Test de l'API...$(NC)"
	@curl -s http://localhost:5000/api | jq . || echo "API non disponible"

backup-db: ## Sauvegarder la base de donnÃ©es
	@echo "$(YELLOW)ðŸ’¾ Sauvegarde de la base de donnÃ©es...$(NC)"
	@docker exec gestion_db pg_dump -U admin gestion_commerciale > backup_$(shell date +%Y%m%d_%H%M%S).sql
	@echo "$(GREEN)âœ… Sauvegarde crÃ©Ã©e$(NC)"

default: help